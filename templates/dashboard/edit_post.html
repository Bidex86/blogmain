{% extends 'dashboard/dashboard.html' %}
{% block meta_robots %}noindex, nofollow{% endblock %}
{% load crispy_forms_tags %}
{% load static %}

{% block dashboard_content %}

<div class="dashboard-container">
    
    <!-- Main Content -->
    <main class="dashboard-main">
        <h2 class="dashboard-title">Edit Post: {{ post.title }}</h2>

        <!-- Display success/error messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <strong>
                        {% if message.tags == 'success' %}✓{% elif message.tags == 'warning' %}⚠{% elif message.tags == 'error' %}✗{% endif %}
                    </strong>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Current Post Info -->
        {% if post %}
            <div class="current-post-info">
                <div class="post-status-bar">
                    <span class="status-badge status-{{ post.status|lower }}">{{ post.status }}</span>
                    <span class="post-meta">
                        Created: {{ post.created_at|date:"M d, Y" }} | 
                        Last Updated: {{ post.updated_at|date:"M d, Y H:i" }}
                    </span>
                    {% if post.is_featured %}
                        <span class="featured-badge">⭐ Featured</span>
                    {% endif %}
                    {% if post.is_editors_pick %}
                        <span class="editors-pick-badge">👑 Editor's Pick</span>
                    {% endif %}
                </div>
                
                <div class="current-tags">
                    <strong>Current Tags:</strong>
                    {% if post.tags.all %}
                        {% for tag in post.tags.all %}
                            <span class="tag-badge">{{ tag.name }}</span>
                        {% endfor %}
                    {% else %}
                        <em>No tags assigned</em>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Newsletter Preview Section (only if editing will send newsletter) -->
        {% if post and post.status != 'Published' %}
            <div class="post-preview">
                <h3>📧 Newsletter Preview</h3>
                <p>If you change status to "Published", this is how your post will appear in subscriber emails:</p>
                
                <div class="newsletter-preview">
                    <h4>{{ post.title }}</h4>
                    <p class="post-meta">
                        By: {{ post.author.get_full_name|default:post.author.username }}
                    </p>
                    {% if post.short_description %}
                        <p>{{ post.short_description }}</p>
                    {% else %}
                        <p>{{ post.blog_body|truncatewords:30|striptags }}...</p>
                    {% endif %}
                    <a href="{% url 'blogs' category_slug=post.category.slug slug=post.slug %}" class="read-more-btn">Read Full Post</a>
                </div>
                
                <hr>
                <small class="newsletter-info">
                    📬 This will be sent to all newsletter subscribers if status changes to "Published".
                    <br>
                    <strong>Note:</strong> Newsletter is only sent when first publishing a post, not on subsequent edits.
                </small>
            </div>
        {% elif post.status == 'Published' %}
            <div class="post-preview published-notice">
                <h3>📝 Editing Published Post</h3>
                <p class="notice">
                    ✅ This post is already published. Changes will be saved but no new newsletter will be sent.
                </p>
                <div class="post-links">
                    <a href="{% url 'blogs' category_slug=post.category.slug slug=post.slug %}" target="_blank" class="view-live-btn">
                        🔗 View Live Post
                    </a>
                    {% if post.category %}
                        <a href="{% url 'posts_by_category' post.category.slug %}" target="_blank" class="view-category-btn">
                            📂 View Category
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <div class="dashboard-form-wrapper">
            <form action="{% url 'edit_post' post.id %}" method="POST" enctype="multipart/form-data" class="dashboard-form">
                {% csrf_token %}
                {{ form.media }}
                {{ form|crispy }}
                
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="submit" class="btn-primary save-button">
                        💾 Save Changes
                    </button>
                    
                    <a href="{% url 'dashboard' %}" class="btn-secondary cancel-button">
                        ↩️ Cancel & Return to Dashboard
                    </a>
                    
                    {% if post.status == 'Published' %}
                        <a href="{% url 'blogs' category_slug=post.category.slug slug=post.slug %}" target="_blank" class="btn-outline view-post-button">
                            👁️ View Live Post
                        </a>
                    {% endif %}
                </div>
                
                <div class="save-note">
                    <p><strong>Save Behavior:</strong></p>
                    <ul>
                        <li>✅ Changes will be saved immediately</li>
                        <li>📧 Newsletter only sent when first publishing (not on edits)</li>
                        <li>🔄 SEO and image optimization will run automatically</li>
                    </ul>
                </div>
            </form>
        </div>
    </main>
</div>

{% endblock %}