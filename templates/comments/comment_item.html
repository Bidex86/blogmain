{% load comment_tags %}
{% load profile_filters %}

<div class="comment-item {{ comment.depth|depth_class }}" data-comment-id="{{ comment.id }}" id="comment-{{ comment.id }}">
    <div class="comment-wrapper">
        <div class="comment-header">
            <img src="{{ comment.user|get_avatar_url }}" 
                 alt="{{ comment.user.username }}" 
                 class="comment-avatar">
            <div class="comment-meta">
                <strong class="comment-author">{{ comment.user.get_full_name|default:comment.user.username }}</strong>
                <time datetime="{{ comment.created_at|date:'c' }}" class="comment-time">
                    {{ comment.created_at|timesince }} ago
                </time>
                {% if comment.is_edited %}
                    <span class="edited-indicator" title="This comment has been edited">(edited)</span>
                {% endif %}
                {% if comment.is_flagged %}
                    <span class="flagged-indicator" title="This comment has been flagged">⚠️</span>
                {% endif %}
            </div>
        </div>
        
        <div class="comment-content">
            {{ comment.comment|linebreaks }}
        </div>
        
        <div class="comment-actions">
            {% if user.is_authenticated %}
                <!-- Like button -->
                <form method="post" action="{% url 'comments:like_comment' comment.id %}" class="like-form inline-form">
                    {% csrf_token %}
                    <button type="submit" class="btn-like">
                        <i class="fas fa-thumbs-up"></i> 
                        <span class="like-count">{{ comment.likes.count }}</span>
                    </button>
                </form>
                
                <!-- Reply button -->
                {% if comment|can_reply_to:user %}
                    <button class="reply-btn btn-action" data-comment-id="{{ comment.id }}">
                        <i class="fas fa-reply"></i> Reply
                    </button>
                {% endif %}
                
                <!-- Edit button (only for comment author) - FIXED SYNTAX -->
                {% if comment|can_be_edited_by:user %}
                    <a href="{% url 'comments:edit_comment' comment.id %}" class="btn-action edit-btn">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                {% endif %}
                
                <!-- Delete button (for author or staff) -->
                {% if comment.user == user or user.is_staff %}
                    <form method="post" action="{% url 'comments:delete_comment' comment.id %}" class="delete-form inline-form" onsubmit="return confirm('Are you sure you want to delete this comment?')">
                        {% csrf_token %}
                        <button type="submit" class="btn-action delete-btn">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </form>
                {% endif %}
                
                <!-- Flag button (not for comment author) -->
                {% if comment.user != user %}
                    <button class="flag-btn btn-action" data-comment-id="{{ comment.id }}">
                        <i class="fas fa-flag"></i> Flag
                    </button>
                {% endif %}
            {% endif %}
        </div>
        
        <!-- Reply form (hidden by default) -->
        <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display: none;">
            <form method="post" action="{% url 'comments:add_comment' %}" class="reply-form">
                {% csrf_token %}
                <input type="hidden" name="content_type_id" value="{{ content_type_id }}">
                <input type="hidden" name="object_id" value="{{ object.id }}">
                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                
                <div class="reply-form-header">
                    <img src="{{ user|get_avatar_url }}" 
                         alt="{{ user.username }}" 
                         class="reply-avatar">
                    <span>Replying to {{ comment.user.get_full_name|default:comment.user.username }}</span>
                </div>
                
                <textarea name="comment" 
                          class="form-control reply-textarea" 
                          placeholder="Write your reply..." 
                          rows="3" 
                          maxlength="1000" 
                          required></textarea>
                
                <div class="reply-form-actions">
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="fas fa-paper-plane"></i> Post Reply
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary cancel-reply">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Flag form (hidden by default) -->
        <div class="flag-form-container" id="flag-form-{{ comment.id }}" style="display: none;">
            <form method="post" action="{% url 'comments:flag_comment' comment.id %}" class="flag-form">
                {% csrf_token %}
                <h5>Report this comment</h5>
                <div class="form-group">
                    <label for="reason-{{ comment.id }}">Reason:</label>
                    <select name="reason" id="reason-{{ comment.id }}" class="form-control" required>
                        <option value="spam">Spam</option>
                        <option value="abuse">Abusive Language</option>
                        <option value="harassment">Harassment</option>
                        <option value="inappropriate">Inappropriate Content</option>
                        <option value="off_topic">Off Topic</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description-{{ comment.id }}">Additional details (optional):</label>
                    <textarea name="description" 
                              id="description-{{ comment.id }}" 
                              class="form-control" 
                              rows="2" 
                              placeholder="Explain why you're reporting this comment..."></textarea>
                </div>
                <div class="flag-form-actions">
                    <button type="submit" class="btn btn-sm btn-warning">
                        <i class="fas fa-flag"></i> Report
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary cancel-flag">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Nested replies -->
    {% if comment.children.all %}
        <div class="comment-replies">
            {% for reply in comment.children.all %}
                {% if reply.is_approved %}
                    {% include 'comments/comment_item.html' with comment=reply %}
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
</div>